
syntax = "proto3";

// Void type, used for messages without arguments or return value.
message Empty {}

message Position {
  int32 line = 1;
  int32 col = 2;
}

// A location
message Location {
  optional string file = 1;
  Position start = 2;
  Position stop = 3;
}

message Error {
  /// An error message
  message Message {
    string msg = 1;

    /// Locations for this message
    repeated Location locs = 2;

    /// Captured backtrace
    optional string backtrace = 3;
  }

  // The toplevel error message.
  Message msg = 1;

  /// A string description of the kind of error
  string kind = 2;

  /// Context for the error.
  repeated Message stack = 3;

  optional string process = 4;
}

message TaskID {
  // The task identifier.
  bytes id = 1;
}

// ## Session management

// A session identifier.
message Session {
  // The session's unique ID (e.g a uuid). 
  bytes id = 1;
}

message SessionCreate {
  /// Do we check Proof Obligations? Default true.
  optional bool po_check = 1;
}

service SessionManager {
  // Create a new session.
  rpc create_session(SessionCreate) returns (Session);
}

// ## Evaluation of snippets
//
// Here we evalute snippets of imandra code that do not live
// explicitly in a file. As would be the case in a REPL,
// or a notebook, they are just free-floating code snippets.

message CodeSnippet {
  Session session = 1;

  /// Code snippet.
  string code = 2;
}

enum EvalResult {
  EVAL_OK = 0;
  EVAL_ERRORS = 1;
}

message CodeSnippetEvalResult {
  // Result of the evaluation
  EvalResult res = 1;

  // TODO: defined CIR symbols

  /// Duration in seconds.
  float duration_s = 3;

  // Tasks produced in the evaluation.
  repeated TaskID tasks = 9;

  // Errors occurring during evaluation.
  repeated Error errors = 10;
}


service Eval {
  /// Evaluate a snippet
  rpc eval_code_snippet(CodeSnippet) returns (CodeSnippetEvalResult);


}

// TODO: task API

// ## GC statistics.
//
// This part of the API is mostly redundant given we have telemetry,
// but it's still good to have in a pinch.

message Gc_stats {
  int64 heap_size_B = 1;
  int64 major_collections = 2;
  int64 minor_collections = 3;
}

message VersionResponse {
  string version = 1;
  optional string git_version = 2;
}

/// Service returning data about the ImandraX system itself.
service System {
  /// Return the system's version
  rpc version(Empty) returns (VersionResponse);

  /// Capture GC statistics
  rpc gc_stats(Empty) returns (Gc_stats);

  /// Try to free memory, return stats
  rpc release_memory(Empty) returns (Gc_stats);
}

